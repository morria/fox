#!/bin/bash
#
# Fox BBS Session Start Hook
#
# This hook runs automatically when Claude Code starts a new session.
# It ensures the development environment matches CI/CD and all checks pass.
#

set -e  # Exit on any error

echo "ðŸ¦Š Fox BBS Session Start Hook"
echo "================================"
echo ""

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if we had any warnings
WARNINGS=0

# Check 1: Python version
echo "ðŸ“‹ Checking Python version..."
PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
PYTHON_MAJOR=$(echo $PYTHON_VERSION | cut -d. -f1)
PYTHON_MINOR=$(echo $PYTHON_VERSION | cut -d. -f2)

if [ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -ge 9 ] && [ "$PYTHON_MINOR" -le 11 ]; then
    echo -e "${GREEN}âœ“${NC} Python $PYTHON_VERSION (CI uses 3.9, 3.10, 3.11)"
else
    echo -e "${YELLOW}âš ${NC} Python $PYTHON_VERSION (CI uses 3.9-3.11, may have compatibility issues)"
    WARNINGS=$((WARNINGS + 1))
fi
echo ""

# Check 2: Development dependencies
echo "ðŸ“¦ Checking development dependencies..."
if ! python3 -c "import pytest" 2>/dev/null; then
    echo -e "${YELLOW}âš ${NC} Development dependencies not found"
    echo "   Installing from requirements-dev.txt..."
    pip install -q -r requirements-dev.txt
    echo -e "${GREEN}âœ“${NC} Development dependencies installed"
else
    echo -e "${GREEN}âœ“${NC} Development dependencies installed"
fi
echo ""

# Check 3: Production dependencies
echo "ðŸ“¦ Checking production dependencies..."
if ! python3 -c "import yaml" 2>/dev/null; then
    echo -e "${YELLOW}âš ${NC} Production dependencies not found"
    echo "   Installing from requirements.txt..."
    pip install -q -r requirements.txt
    echo -e "${GREEN}âœ“${NC} Production dependencies installed"
else
    echo -e "${GREEN}âœ“${NC} Production dependencies installed"
fi
echo ""

# Check 4: Run formatting check
echo "ðŸŽ¨ Checking code formatting..."
if black --check src/ tests/ fox_bbs.py 2>/dev/null && isort --check-only src/ tests/ fox_bbs.py 2>/dev/null; then
    echo -e "${GREEN}âœ“${NC} Code formatting is correct"
else
    echo -e "${YELLOW}âš ${NC} Code formatting issues found"
    echo "   Run 'make format' to fix"
    WARNINGS=$((WARNINGS + 1))
fi
echo ""

# Check 5: Run linting
echo "ðŸ” Running linter..."
if make lint >/dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC} Linting passed"
else
    echo -e "${YELLOW}âš ${NC} Linting issues found"
    echo "   Run 'make lint' for details"
    WARNINGS=$((WARNINGS + 1))
fi
echo ""

# Check 6: Run type checking
echo "ðŸ”Ž Running type checker..."
if make type-check >/dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC} Type checking passed"
else
    echo -e "${YELLOW}âš ${NC} Type checking issues found"
    echo "   Run 'make type-check' for details"
    WARNINGS=$((WARNINGS + 1))
fi
echo ""

# Check 7: Run tests
echo "ðŸ§ª Running tests..."
if make test >/dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC} All tests passed"
else
    echo -e "${YELLOW}âš ${NC} Some tests failed"
    echo "   Run 'make test' for details"
    WARNINGS=$((WARNINGS + 1))
fi
echo ""

# Summary
echo "================================"
if [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}âœ“ Environment ready! All checks passed.${NC}"
    echo ""
    echo "You can now:"
    echo "  â€¢ Make changes to the codebase"
    echo "  â€¢ Run 'make format' to auto-format code"
    echo "  â€¢ Run 'make all' to run all checks"
    echo "  â€¢ Commit with confidence (pre-commit hook will validate)"
else
    echo -e "${YELLOW}âš  Environment ready with $WARNINGS warning(s)${NC}"
    echo ""
    echo "Please review the warnings above and fix any issues before committing."
    echo "Run 'make all' to see detailed output from all checks."
fi
echo ""
